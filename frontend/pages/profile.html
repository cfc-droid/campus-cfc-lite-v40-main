<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil ‚Äî Campus CFC LITE</title>
  <link rel="stylesheet" href="../css/premium.css?v=20251105" />

  <style>
    /* =========================================================
       ‚úÖ CFC_FUNC_8_2D_20251105 ‚Äî Bot√≥n flotante modo oscuro/claro sincronizado
       ========================================================= */
    #themeToggle {
      position: fixed;
      top: 18px;
      right: 22px;
      background: rgba(255,215,0,0.2);
      border: 2px solid rgba(255,215,0,0.4);
      color: #FFD700;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.3s;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 10px rgba(255,215,0,0.3);
      z-index: 1000;
    }
    #themeToggle:hover { background:#FFD700; color:#000; transform:scale(1.05); }

    body.light-mode { background:#f9f9f9; color:#111; }
    body.dark-mode { background:#000; color:#e0e0e0; }

    /* ‚úÖ Bloque examen din√°mico adaptativo */
    .ultimo-examen h3 { color: #FFD700; font-size: 1.1rem; }
    .ultimo-examen p {
      font-size: 0.95rem;
      line-height: 1.4;
      margin-top: 6px;
      transition: color 0.3s ease;
    }
    body.dark-mode .ultimo-examen p { color: #fff; }
    body.light-mode .ultimo-examen p { color: #000; }
  </style>
</head>

<body>
  <header>
    <h2>üë§ Perfil del Usuario</h2>
  </header>

  <!-- üåó Bot√≥n de cambio de tema -->
  <div id="themeToggle" title="Cambiar tema">üåô</div>

  <main style="text-align:center;">
    <p>Esta es la p√°gina de Perfil del Campus CFC LITE V41 REAL.</p>

    <div style="margin-top:30px;">
      <button id="btnStats" class="btn-main">üìä Mi progreso</button>
    </div>

    <section id="emocion-section" style="margin-top:30px;">
      <h3>üß† Estado Emocional Diario</h3>
      <div id="emotionScore" style="font-size:1.5rem;margin-top:10px;font-weight:bold;color:#FFD700;"></div>
      <p id="emotionMessage" style="color:#ccc;font-size:0.9rem;margin-top:8px;"></p>
    </section>

    <div class="bitacora-access" style="margin-top:30px;">
    <button class="btn-bitacora" onclick="window.location.href='../pages/bitacora_v416.html?v=20251107CFC_FIX4'">
        üß† Bit√°cora Mental del Trader
      </button>
      <p style="font-size:0.85rem;color:#aaa;margin-top:6px;">Registr√° tus reflexiones y aprendizajes del d√≠a.</p>
    </div>

    <div class="return-container" style="margin-top:25px;">
      <button class="btn-return" onclick="window.location.href='../modules/index.html'">‚¨Ö Volver al Campus</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>
  <script src="../js/footer.js" defer></script>
  <script src="../js/stats_v1.js" defer></script>
  <script src="../js/activity_tracker.js?v=20251106" defer></script>
  <script src="../js/theme_chapter.js?v=20251105" defer></script>

  <!-- =========================================================
       ‚úÖ CFC_FUNC_10_4_V41.16 ‚Äî Estado emocional + √∫ltimo examen
       ========================================================= -->
  <script>
    // ‚úÖ Estado emocional
    const scoreRaw = localStorage.getItem("emotionScore");
    const box = document.getElementById("emotionScore");
    const msg = document.getElementById("emotionMessage");
    if (scoreRaw && !isNaN(parseInt(scoreRaw))) {
      const val = parseInt(scoreRaw, 10);
      let emoji="üôÇ",mensaje="Buen enfoque mental.";
      if (val<=3){emoji="üòî";mensaje="Momento de reconectar con tu calma.";}
      else if (val<=6){emoji="üòê";mensaje="Est√°s estable, pero pod√©s mejorar tu enfoque.";}
      else if (val<=8){emoji="üòä";mensaje="Excelente disciplina emocional.";}
      else if (val<=10){emoji="üî•";mensaje="M√°xima claridad mental, segu√≠ as√≠.";}
      box.textContent=`${emoji} ${val}/10`;
      msg.textContent=mensaje;
    } else {
      box.textContent="‚ö†Ô∏è A√∫n no registraste tu emoci√≥n de hoy.";
      msg.textContent="Registr√° tu autoevaluaci√≥n al cargar el Campus.";
    }

    // ‚úÖ √öltimo examen completado
    function mostrarUltimoExamen() {
      try {
        const examResults = JSON.parse(localStorage.getItem("examResults")) || [];
        if (!examResults.length) return;
        const ultimo = examResults.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const contenedor = document.querySelector("main");
        const bloque = document.createElement("div");
        bloque.className = "ultimo-examen";
        bloque.innerHTML = `
          <h3>üìò √öltimo examen completado</h3>
          <p>
            <strong>${ultimo.module}</strong><br>
            Puntaje: <b style="color:#FFD700;">${ultimo.score}%</b> ‚Äî ${ultimo.status}<br>
            ‚è±Ô∏è ${ultimo.duration} &nbsp;|&nbsp; üìÖ ${ultimo.date} ${ultimo.time}
          </p>`;
        contenedor.appendChild(bloque);
      } catch (err) {
        console.warn("‚ö†Ô∏è Error al mostrar √∫ltimo examen:", err);
      }
    }

    function actualizarColoresExamen() {
      const body = document.body;
      const bloque = document.querySelector(".ultimo-examen p");
      if (!bloque) return;
      bloque.style.color = body.classList.contains("light-mode") ? "#000" : "#fff";
    }

    document.addEventListener("DOMContentLoaded", () => {
      mostrarUltimoExamen();
      actualizarColoresExamen();
    });

    window.addEventListener("storage", (e) => {
      if (e.key === "CFC_THEME_STATE") actualizarColoresExamen();
    });
    const observer = new MutationObserver(actualizarColoresExamen);
    observer.observe(document.body, { attributes: true, attributeFilter: ["class"] });
  </script>

  <!-- =========================================================
       ‚úÖ CFC_FUNC_11_3_V41.34 ‚Äî Panel ‚ÄúMi progreso‚Äù unificado (fondo fix + √∫ltima sesi√≥n)
       üìÑ Archivo: /frontend/pages/profile.html
       üîí CFC-SYNC V11.3 | QA-SYNC V41.34
       ========================================================= -->
  <script>
  document.getElementById("btnStats").addEventListener("click", () => {
    const prev = document.querySelector("#miProgresoOverlay");
    if (prev) prev.remove();

    const totalSeconds = parseFloat(localStorage.getItem("CFC_time_total") || 0);
    const minutes = Math.floor(totalSeconds / 60);
    const hours = Math.floor(minutes / 60);
    const remMin = minutes % 60;

    const data = JSON.parse(localStorage.getItem("progressData") || "{}");
    const completed = (data.completed || []).length;
    const percent = Math.floor((completed / 20) * 100);

    let lastDate = localStorage.getItem("CFC_lastDate");
    if (!lastDate || lastDate === "‚Äî") {
      const today = new Date().toLocaleDateString("es-AR");
      localStorage.setItem("CFC_lastDate", today);
      lastDate = today;
    }

    const consecutive = localStorage.getItem("CFC_days") || 0;
    const totalDays = localStorage.getItem("CFC_totalDays") || 0;

    const overlay = document.createElement("div");
    overlay.id = "miProgresoOverlay";
    overlay.style = `
      position:fixed;inset:0;z-index:99999;
      background:rgba(0,0,0,0.88);color:#FFD700;
      font-family:'Poppins',sans-serif;display:flex;
      justify-content:center;align-items:center;flex-direction:column;
      text-align:center;line-height:1.6;opacity:0;
      transition:opacity .6s ease-in-out;
    `;

    overlay.innerHTML = `
      <div style="max-width:480px;padding:30px;
        background:rgba(40,40,40,0.85);
        backdrop-filter:blur(10px);
        border:1px solid #FFD700;border-radius:14px;
        box-shadow:0 0 25px rgba(255,215,0,0.5);
        text-align:left;">
        <h2 style="text-align:center;">üìä Tu progreso</h2>
        <ul style="list-style:none;padding-left:0;font-size:0.95rem;line-height:1.8;">
          <li>üìò <b>M√≥dulos completados:</b> ${completed}/20 (${percent}%)</li>
          <li>‚è±Ô∏è <b>Horas activas:</b> ${hours} h ${remMin} min</li>
          <li>üìÖ <b>√öltima sesi√≥n:</b> ${lastDate}</li>
          <li>üîÅ <b>D√≠as consecutivos de estudio:</b> ${consecutive}</li>
          <li>üóìÔ∏è <b>D√≠as totales de estudio:</b> ${totalDays}</li>
        </ul>
        <div style="text-align:center;margin-top:20px;">
          <button id="cerrarProgreso" class="btn-main">Cerrar</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    setTimeout(() => (overlay.style.opacity = 1), 50);

    document.getElementById("cerrarProgreso").addEventListener("click", () => {
      overlay.style.opacity = 0;
      setTimeout(() => overlay.remove(), 300);
    });

    console.log(
      "üß© CFC_SYNC checkpoint:",
      `Progreso actualizado ‚Üí ${hours}h ${remMin}min ‚Äî ${percent}% ‚Äî √öltima sesi√≥n: ${lastDate}`,
      new Date().toLocaleString()
    );
  });
  </script>

  <!-- üîí CFC_LOCK: V41.34-profile_fixOverlayLastDate-20251106 -->
</body>
</html>
